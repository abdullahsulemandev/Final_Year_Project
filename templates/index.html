<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Analyzer</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='base.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='index.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <style>
        .feedback-section {
            background-color: #f9f9f9;
            padding: 20px;
            text-align: center;
            margin: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .feedback-section h2 {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 15px;
        }

        .feedback-section p {
            font-size: 16px;
            margin-bottom: 20px;
        }

        .feedback-section a {
            text-decoration: none;
            font-size: 14px;
            font-weight: 600;
            background-color: #9147ff;
            color: white;
            padding: 10px 20px;
            border-radius: 4px;
            transition: background-color 0.3s;
        }

        .feedback-section a:hover {
            background-color: #772ce8;
        }

        /* Progress Bar Styles */
        .btn-download {
            display: inline-block;
            outline: 0;
            border: none;
            cursor: pointer;
            font-weight: 600;
            border-radius: 4px;
            font-size: 13px;
            height: 33px;
            background-color: #9147ff;
            color: white;
            padding: 0 10px;
            text-align: center;
            transition: background-color 0.3s;
        }

        .btn-download:hover {
            background-color: #772ce8;
        }

        .progress-bar {
            width: 50%;
            height: 20px;
            background-color: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            margin-top: 10px;
        }

        .progress-bar-inner {
            height: 100%;
            width: 0%;
            background-color: #9147ff;
            transition: width 0.3s ease;
        }

        .message {
            text-align: center;
            margin-top: 20px;
        }

        /* Filter Section Styles */
        .filter-section {
            background-color: #f9f9f9;
            padding: 20px;
            text-align: center;
            margin: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .filter-section h3 {
            font-size: 22px;
            font-weight: bold;
            margin-bottom: 15px;
        }

        .filter-section select,
        .filter-section button {
            padding: 10px 20px;
            font-size: 16px;
            border-radius: 5px;
            border: 1px solid #ccc;
            margin-top: 10px;
        }

        .filter-section button {
            background-color: #9147ff;
            color: white;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .filter-section button:hover {
            background-color: #772ce8;
        }
    </style>
</head>

<body>
    <nav class="navbar">
        <div class="container">
            <h1 class="navbar-brand">Video Analyzer</h1>
            <ul class="navbar-menu">
                <li><a href="{{ url_for('index') }}">Home</a></li>
                {% if not session.get('user') %}
                    <li><a href="{{ url_for('login') }}">Login</a></li>
                    <li><a href="{{ url_for('signup') }}">Signup</a></li>
                {% else %}
                    <li><a href="{{ url_for('logout') }}">Logout</a></li>
                {% endif %}
                <li><a href="{{ url_for('subscription') }}" class="btn-subscribe">Subscription</a></li>
            </ul>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="upload-container">
        <form id="upload-form" enctype="multipart/form-data">
            <input type="file" id="video-file" name="video" accept="video/mp4">
            <label for="video-file" class="btn-1">üìÅ Select file</label>
            <span id="file-label"></span>
            <button type="submit" style="margin-left: 20px;">Upload Video</button>
        </form>
    </div>

    <div class="progress-container">
        <div id="progress-bar" class="progress-bar">
            <div id="progress-bar-inner" class="progress-bar-inner"></div>
        </div>
    </div>

    <div class="download-container" id="download-container" style="display: none;">
        <a id="download-link" href="/download_video/{{ video_id }}" class="btn-download">Download Detected Video</a>
    </div>

    <div class="message" id="message">
        <p>No videos have been uploaded yet.</p>
    </div>

    <div class="subscription-container">
        <h2>Unlock Premium Features!</h2>
        <p>Get access to advanced detection features and unlimited uploads.</p>
        <a href="{{ url_for('subscription') }}" class="btn-subscribe">Subscribe Now</a>
    </div>

  <!-- Filter Section -->
<div class="filter-section">
    <h3>History of All Detected Filters</h3>
    <ul id="filterContainer">
        <!-- Filters will be dynamically added here -->
    </ul>
</div>

<div class="filter-section">
    <h3>Applied Detection Filter</h3>
    <ul id="filter-container">
        <!-- Filter results will be populated here -->
    </ul>
</div>

    <!-- Feedback Section -->
    <div class="feedback-section">
        <h2>We Value Your Feedback</h2>
        <p>Help us improve by sharing your thoughts and suggestions.</p>
        <a href="{{ url_for('feedback') }}">Give Feedback</a>
    </div>

    <script>
    // Function to fetch and display filters
function fetchFilters() {
     // Fetch filters from the server
fetch('/get_filters')
    .then(response => response.json())
    .then(data => {
        console.log('Filters fetched:', data);  // Log the response for debugging

        const filterContainer = document.getElementById('filterContainer');
        filterContainer.innerHTML = ''; // Clear the list before populating it

        if (data.filters && data.filters.length > 0) {
            data.filters.forEach(filter => {
                const li = document.createElement('li');
                // Display filter, timestamp, and user_email
                li.textContent = `Filter: ${filter.filter} | Applied at: ${filter.timestamp} | User Email: ${filter.user_email}`;
                filterContainer.appendChild(li);
            });
        } else {
            filterContainer.innerHTML = '<li>No filters applied yet.</li>';
        }
    })
    .catch(error => {
        console.error('Error fetching filters:', error);
        alert('An error occurred while fetching the filters.');
    });

// Call the function to display filters when the page loads
document.addEventListener('DOMContentLoaded', fetchFilters);

 }

 // Call the function to display filters when the page loads
 document.addEventListener('DOMContentLoaded', fetchFilters);


        // Handle the video upload form submission
        document.getElementById('upload-form').addEventListener('submit', function (event) {
            event.preventDefault();
            var formData = new FormData();
            var file = document.getElementById('video-file').files[0];

            if (!file) {
                alert('Please select a video file.');
                return;
            }

            formData.append('video', file);

            // Show the progress bar container immediately after file upload starts
            document.querySelector('.progress-container').style.display = 'block';
            const progressBarInner = document.getElementById('progress-bar-inner');
            progressBarInner.style.width = '0%'; // Reset progress to 0

            // Send the form data to the server
            fetch('/home', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.message) {
                    alert(data.message);

                    // Start checking progress
                    const videoId = data.video_id;
                    checkProgress(videoId);
                } else {
                    alert('Failed to upload video.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred during upload.');
            });
        });

        // Function to check progress
        function checkProgress(videoId) {
            const progressBarInner = document.getElementById('progress-bar-inner');
            const message = document.getElementById('message');
            const downloadContainer = document.getElementById('download-container');
            const downloadLink = document.getElementById('download-link');
            const filterContainer = document.getElementById('filterContainer');  // Where filters will be displayed

            const interval = setInterval(() => {
        fetch(`/progress/${videoId}`)
            .then(response => response.json())
            .then(data => {
                const progress = data.progress;
                progressBarInner.style.width = `${progress}%`; // Update progress bar width

                if (progress >= 100) {
                    clearInterval(interval);
                    message.innerHTML = '<p>Video processing complete. You can now download the detected video.</p>';
                    downloadContainer.style.display = 'flex'; // Show the download button
                    downloadLink.href = `/download_video/${videoId}`;

                    // Now, fetch the applied filter for this video
                    // Assuming `videoId` is already defined and pointing to the video you want to fetch filters for
fetch(`/get_applied_filter/${videoId}`)
    .then(response => response.json())
    .then(data => {
        const filterContainer = document.getElementById('filter-container'); // Make sure this element exists in your HTML

        // Check if filters are returned and display them
        if (data.filters && data.filters.length > 0) {
            const filterList = data.filters.map(filter => {
                return `<li>Applied Filter: ${filter.filter} (Applied at: ${filter.timestamp})</li>`;
            }).join('');
            filterContainer.innerHTML = filterList;
        } else {
            filterContainer.innerHTML = '<li>No filter applied yet.</li>';
        }
    })
    .catch(error => {
        console.error('Error fetching applied filter:', error);
        filterContainer.innerHTML = '<li>Error fetching applied filter.</li>';
    });

                }
            })
            .catch(error => {
                console.error('Error fetching progress:', error);
                clearInterval(interval);
                message.innerHTML = '<p>An error occurred while processing the video.</p>';
            });
    }, 1000); // Check progress every 1 second
}
        // Handle filter form submission
        document.getElementById('filter-form').addEventListener('submit', function (event) {
            event.preventDefault();
            var selectedFilter = document.getElementById('filter-select').value;
            // Send the filter to the server (you can add an endpoint to handle this)
            alert('Selected filter: ' + selectedFilter);
        });
    </script>
</body>

</html>
